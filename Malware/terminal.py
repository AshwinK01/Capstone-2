import os
import vt
import sys
from dotenv import load_dotenv
load_dotenv()

# Load VirusTotal API key
API_KEY = os.getenv("VIRUSTOTAL_API_KEY")


def classify_url(client, url):
    """Classify a URL using VirusTotal."""
    try:
        # Submit URL for scanning or retrieve existing scan
        url_id = vt.url_id(url)
        analysis = client.get_object(f"/urls/{url_id}")
        permalink = f"https://www.virustotal.com/gui/url/{url_id}/details"
        
        print(f"\nClassification Results for URL: {url}")
        print(f"Verdict: {analysis.last_analysis_stats}")
        print(f"Permalink: {permalink}")
    except vt.error.APIError as e:
        print(f"Error: {e}")
    except Exception as e:
        print(f"Unexpected error: {e}")

def classify_file(client, file_path):
    """Classify a file using VirusTotal."""
    try:
        with open(file_path, "rb") as file:
            analysis = client.scan_file(file)
        permalink = f"https://www.virustotal.com/gui/file/{analysis.id}/details"
        
        print(f"\nFile uploaded for analysis. Scan ID: {analysis.id}")
        print(f"Permalink: {permalink}")
    except FileNotFoundError:
        print(f"Error: File '{file_path}' not found.")
    except vt.error.APIError as e:
        print(f"Error: {e}")
    except Exception as e:
        print(f"Unexpected error: {e}")

def main():
    print("=== Malware Classifier ===")
    print("Options:")
    print("1. Classify a URL")
    print("2. Classify a File (PDF)")
    print("3. Exit")
    
    client = vt.Client(API_KEY)
    
    try:
        while True:
            choice = input("\nEnter your choice (1/2/3): ")
            if choice == "1":
                url = input("Enter the URL to classify: ")
                classify_url(client, url)
            elif choice == "2":
                file_path = input("Enter the path to the PDF file: ")
                classify_file(client, file_path)
            elif choice == "3":
                print("Exiting. Thank you!")
                break
            else:
                print("Invalid choice. Please try again.")
    finally:
        client.close()

if __name__ == "__main__":
    if not API_KEY:
        print("Error: Please set your VirusTotal API key in the API_KEY variable.")
        sys.exit(1)
    main()